# 需求文档

## 引言

本需求文档针对 CallRecordManager 应用录音列表界面的两个 UI/UX 改进：

1. **语音转写进度状态显示**：当前每条录音只显示"已转写"的最终状态标记，用户无法了解转写过程中所处的具体阶段。需要在每条录音卡片下方增加细粒度的流水线进度状态指示器，覆盖从转写、纪要生成到完成的全部状态节点。

2. **浮动操作按钮（FAB）与列表项按钮干涉**：当前录音主界面右下角有两个 FloatingActionButton（加号/添加文件 + 刷新/扫描），它们与列表最后几项的操作按钮（如"更多"菜单）在位置上重叠，用户在点击列表底部的录音项操作时，容易误触 FAB 按钮。同时 TopAppBar 中已存在刷新按钮，FAB 中的刷新按钮属于功能重复。

---

## 需求

### 需求 1：每条录音显示细粒度的转写流水线进度状态

**用户故事：** 作为一名应用用户，我希望在每条录音卡片下方看到该录音的转写处理进度状态，以便我能清楚了解每条录音当前处于转写流程的哪个阶段（待处理 → 转写中 → 转写完成 → 纪要生成中 → 全部完成 / 失败）。

#### 验收标准

1. WHEN 一条录音尚未开始转写 THEN 系统 SHALL 在该录音卡片下方显示"待处理"状态标签（灰色），表示该录音可以执行转写操作。

2. WHEN 用户触发转写操作 THEN 系统 SHALL 将该录音的状态更新为"转写中"，在卡片下方显示带旋转加载指示器的"转写中..."标签（蓝色/主题色），并实时反映当前处理阶段。

3. WHEN 转写 API 返回成功结果 THEN 系统 SHALL 将该录音的状态更新为"转写完成"，并自动进入"纪要生成中"阶段，卡片下方显示"纪要生成中..."标签。

4. WHEN 纪要生成成功完成 THEN 系统 SHALL 将该录音的状态更新为"已完成"，卡片下方显示绿色的"✅ 已完成"状态标签，取代原有的"已转写"芯片。

5. IF 转写或纪要生成过程中发生错误 THEN 系统 SHALL 将状态更新为"失败"，卡片下方显示红色的"❌ 失败"状态标签，并保留失败阶段信息（如"转写失败"或"纪要生成失败"）。

6. WHEN 应用重新启动或录音列表刷新 THEN 系统 SHALL 根据数据库中存储的 `TranscriptStatus`、`isTranscribed` 字段和关联的 `MeetingMinuteEntity` 是否存在，正确还原每条录音的进度状态。

7. WHEN 多条录音同时处于不同状态 THEN 系统 SHALL 为每条录音独立显示其各自的进度状态，互不影响。

---

### 需求 2：修复浮动操作按钮与列表项的点击干涉问题

**用户故事：** 作为一名应用用户，我希望操作录音列表底部的录音项时不会被浮动按钮遮挡或误触，以便我能顺畅地对每条录音执行操作。

#### 验收标准

1. WHEN 录音列表显示时 THEN 系统 SHALL 仅保留一个 FloatingActionButton（加号/添加文件按钮），移除 FAB 中的刷新/扫描按钮（因为 TopAppBar 中已有刷新按钮，功能重复）。

2. WHEN 用户滚动到录音列表底部 THEN 系统 SHALL 确保列表底部有足够的内边距（padding），使最后几条录音的操作按钮区域不被 FAB 遮挡。

3. WHEN 用户点击列表中某条录音的"更多"操作按钮 THEN 系统 SHALL 确保下拉菜单正常弹出，不会被 FAB 按钮拦截点击事件。

4. IF 列表为空或正在加载 THEN 系统 SHALL 隐藏 FAB 按钮（保持现有行为）。

5. WHEN 用户点击单个 FAB（添加文件）按钮 THEN 系统 SHALL 正常触发文件选择器，与现有功能保持一致。

---

## 技术约束与注意事项

### 进度状态的数据来源
- 当前 `CallRecordEntity` 有 `isTranscribed` 和 `transcriptId` 字段
- `TranscriptEntity` 有 `status` 字段（`PENDING`、`PROCESSING`、`COMPLETED`、`FAILED`）
- 纪要是否生成可通过关联查询 `MeetingMinuteEntity` 是否存在来判断
- ViewModel 中已有 `processingRecordId` 和 `processingMessage` 状态，需扩展为支持更细粒度的状态节点

### 状态流转定义
```
未处理 → 转写中 → 转写完成 → 纪要生成中 → 全部完成
                    ↘ 转写失败       ↘ 纪要生成失败
```

### UI 布局约束
- 进度状态条应放在录音卡片内部（联系人名 + 时间 + 通话时长下方），使用紧凑的单行布局
- FAB 区域仅保留一个按钮，减少视觉和操作干扰
- 列表底部需增加额外 padding（约 80dp），为 FAB 留出空间
